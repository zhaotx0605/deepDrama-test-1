# 🔧 局域网访问问题修复

## ❌ 你遇到的问题

**症状**：在局域网其他机器访问 `http://192.168.1.100:5173` 时：
- Console显示：`API Base URL: http://localhost:8080`
- Network请求：`http://localhost:8080/api/stats`（失败）

**原因**：环境变量 `.env.development` 配置了固定的 localhost 地址

---

## ✅ 已修复

### 修改内容
1. ✅ `.env.development` 文件改为空值（启用自动检测）
2. ✅ `src/api/index.js` 增强了自动检测逻辑
3. ✅ 添加详细的Console日志输出

---

## 🚀 立即修复步骤

### 第1步：拉取最新代码
```bash
cd /你的路径/webapp
git pull origin main
```

### 第2步：重启前端

#### 如果用 npm run dev
```bash
# 按 Ctrl+C 停止当前前端

# 重新启动
cd /你的路径/webapp/frontend
npm run dev
```

#### 如果用 PM2
```bash
cd /你的路径/webapp/frontend
pm2 restart deepdrama-frontend
```

### 第3步：验证修复

#### 在其他机器浏览器访问
```
http://192.168.1.100:5173
```

#### 按F12查看Console
应该看到：
```
通过IP访问，自动使用IP后端: http://192.168.1.100:8080
✓ API Base URL: http://192.168.1.100:8080
```

#### 查看Network标签
应该看到：
```
GET http://192.168.1.100:8080/api/stats - 200 OK
GET http://192.168.1.100:8080/api/scripts - 200 OK
```

---

## 🧪 完整测试流程

### 在部署机器上

#### 1. 获取本机IP
```bash
# Windows
ipconfig

# Linux/Mac
ifconfig
```
假设得到：**192.168.1.100**

#### 2. 确认后端运行
```bash
# 测试后端是否可通过IP访问
curl http://192.168.1.100:8080/api/stats
```
应该返回JSON数据 ✅

#### 3. 拉取最新代码
```bash
cd /你的路径/webapp
git pull origin main
```

#### 4. 重启前端
```bash
# 停止前端
Ctrl+C

# 重新启动
cd /你的路径/webapp/frontend
npm run dev
```

启动后会显示：
```
➜  Local:   http://localhost:5173/
➜  Network: http://192.168.1.100:5173/
```

---

### 在其他机器上测试

#### 1. 打开浏览器
```
http://192.168.1.100:5173
```

#### 2. 打开开发者工具
按 `F12` 键

#### 3. 查看Console标签
**应该看到**：
```
通过IP访问，自动使用IP后端: http://192.168.1.100:8080
✓ API Base URL: http://192.168.1.100:8080
App 组件已挂载，开始加载数据...
正在加载统计数据...
统计数据: {totalScripts: 30, totalProjects: 9, ...}
正在加载剧本列表...
剧本列表: (30) [{scriptId: "SP001", ...}, ...]
```

#### 4. 查看Network标签
**应该看到**：
```
Name                              Method  Status  Type
stats                            GET     200     xhr
scripts                          GET     200     xhr
```

点击任一请求，查看：
- **Request URL**: `http://192.168.1.100:8080/api/stats` ✅
- **Status Code**: `200 OK` ✅

#### 5. 验证页面功能
- ✅ 数据看板显示：30个剧本、转化率等
- ✅ 剧本列表正常显示
- ✅ 点击"刷新"按钮有反应
- ✅ 搜索、筛选功能正常

---

## 🔍 如果仍然有问题

### 问题1：没有拉取到最新代码

#### 检查
```bash
cd /你的路径/webapp/frontend
cat .env.development
```

**应该显示**：
```
# 开发环境配置
# 留空以启用自动检测（推荐）
# 自动检测规则：
# - 访问 localhost → 后端使用 localhost:8080
# - 访问 IP地址 → 后端使用 IP:8080
VITE_API_BASE_URL=
```

**如果显示其他内容**，手动修改：
```bash
cd /你的路径/webapp/frontend
echo "# 开发环境配置" > .env.development
echo "# 留空以启用自动检测" >> .env.development
echo "VITE_API_BASE_URL=" >> .env.development
```

---

### 问题2：前端没有重启

#### 症状
修改了代码但Console仍显示 localhost

#### 解决
```bash
# 完全停止前端
Ctrl+C

# 等待2秒

# 重新启动
npm run dev
```

---

### 问题3：有 .env.local 文件覆盖

#### 检查
```bash
cd /你的路径/webapp/frontend
ls -la .env.local
```

#### 如果文件存在
```bash
# 查看内容
cat .env.local

# 如果配置了localhost，删除或修改
rm .env.local

# 或修改为IP
echo "VITE_API_BASE_URL=http://192.168.1.100:8080" > .env.local
```

#### 重启前端
```bash
npm run dev
```

---

### 问题4：浏览器缓存

#### 症状
修改已生效但浏览器仍显示旧结果

#### 解决
在浏览器按：
- **Windows/Linux**: `Ctrl + Shift + R`
- **Mac**: `Cmd + Shift + R`

强制刷新页面，清除缓存

---

## 📊 验证成功的标志

### ✅ Console输出
```
通过IP访问，自动使用IP后端: http://192.168.1.100:8080
✓ API Base URL: http://192.168.1.100:8080
App 组件已挂载，开始加载数据...
正在加载统计数据...
统计数据: {totalScripts: 30, ...}
```

### ✅ Network请求
```
GET http://192.168.1.100:8080/api/stats - 200 OK
GET http://192.168.1.100:8080/api/scripts - 200 OK
```

### ✅ 页面显示
- 数据看板有数据
- 剧本列表有30条记录
- 所有功能正常工作

---

## 💡 自动检测原理

### 代码逻辑
```javascript
const getBaseURL = () => {
  // 1. 优先使用环境变量（如果配置了）
  if (import.meta.env.VITE_API_BASE_URL) {
    return import.meta.env.VITE_API_BASE_URL
  }
  
  // 2. 获取当前访问的主机名
  const hostname = window.location.hostname
  
  // 3. 如果是IP地址，使用相同IP的后端
  if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
    return `http://${hostname}:8080`  // ← 局域网访问走这里
  }
  
  // 4. 默认使用localhost
  return 'http://localhost:8080'
}
```

### 访问示例

#### 本机访问
```
浏览器：http://localhost:5173
window.location.hostname = 'localhost'
→ API使用：http://localhost:8080
```

#### 局域网访问
```
浏览器：http://192.168.1.100:5173
window.location.hostname = '192.168.1.100'
→ API使用：http://192.168.1.100:8080
```

---

## 🎯 快速命令汇总

### 完整修复流程（复制粘贴）
```bash
# 1. 拉取最新代码
cd /你的路径/webapp
git pull origin main

# 2. 进入前端目录
cd frontend

# 3. 确认配置正确
cat .env.development
# 应该看到 VITE_API_BASE_URL= （空值）

# 4. 删除可能的本地覆盖
rm -f .env.local

# 5. 重启前端（先停止Ctrl+C，再执行）
npm run dev

# 6. 在其他机器访问 http://你的IP:5173
# 7. 按F12查看Console，确认使用IP地址
```

---

## 🔗 相关文档

- **详细说明**: `API地址配置说明.md`
- **部署指南**: `局域网部署指南.md`
- **快速指南**: `局域网访问快速指南.md`

---

## 📞 总结

### 问题根源
环境变量配置了固定的 localhost 地址

### 修复方案
1. 清空 `.env.development` 中的 `VITE_API_BASE_URL`
2. 重启前端服务
3. 系统自动根据访问方式选择后端地址

### 验证方法
在其他机器访问，Console应显示IP地址

现在去试试吧！应该可以正常工作了！🚀
